<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seating Arrangement Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }

        /* Compact print styles for PDF */
        .seating-print {
            display: grid;
            gap: 1px;
            padding: 10px;
            background: white;
        }

        .seat-print {
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            background: white;
            border: 1px solid #999;
            padding: 2px;
            text-align: center;
            overflow: hidden;
        }

        .seat-print .roll {
            font-weight: bold;
            font-size: 8px;
            line-height: 1;
        }

        .seat-print .set {
            font-size: 7px;
            opacity: 0.8;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
            }

            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Classroom Seating Arrangement</h1>

        <!-- Controls Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="rows" class="block text-sm font-medium text-gray-700 mb-1">Total Rows</label>
                    <input type="number" id="rows" name="rows" min="1" value="8"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>

                <div>
                    <label for="cols" class="block text-sm font-medium text-gray-700 mb-1">Total Columns</label>
                    <input type="number" id="cols" name="cols" min="1" value="10"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>

                <div>
                    <label for="num-batches" class="block text-sm font-medium text-gray-700 mb-1">Number of
                        Batches</label>
                    <input type="number" id="num-batches" name="num-batches" min="1" max="10" value="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <p class="text-xs text-gray-500 mt-1">Choose how many batches to allocate (1-10)</p>
                </div>

                <div>
                    <label for="broken-seats" class="block text-sm font-medium text-gray-700 mb-1">Broken Seats
                        (Row-Col)</label>
                    <input type="text" id="broken-seats" name="broken-seats" placeholder="e.g., 1-3, 2-1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <p class="text-xs text-gray-500 mt-1">Separate with commas, e.g., 1-3, 2-1</p>
                </div>

                <!-- Dynamic Batch Start Rolls Container -->
                <div id="batch-start-rolls-container" class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Batch Start Rolls</label>
                    <div id="batch-rolls-inputs" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <!-- Populated dynamically by JavaScript -->
                    </div>
                </div>

                <div class="md:col-span-3">
                    <label for="start_rolls" class="block text-sm font-medium text-gray-700 mb-1">Per-batch start roll
                        strings (optional)</label>
                    <input type="text" id="start_rolls" placeholder="e.g. 1:BTCS24O1135,2:BTCD24O2001"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                    <p class="text-xs text-gray-500 mt-1">Format: batchIndex:ROLLSTRING, separated by commas. Example:
                        1:BTCS24O1135,2:BTCD24O2001</p>
                </div>

                <div>
                    <label for="block-width" class="block text-sm font-medium text-gray-700 mb-1">Block Width
                        (cols)</label>
                    <input type="number" id="block-width" min="1" value="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
                </div>

                <div>
                    <label for="fillByColumn" class="block text-sm font-medium text-gray-700 mb-1">Fill Batches By
                        Column</label>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="fillByColumn" checked class="h-5 w-5">
                        <label for="fillByColumn" class="text-sm text-gray-600">Column-major assignment</label>
                    </div>
                </div>

                <div>
                    <label for="enforceAdj" class="block text-sm font-medium text-gray-700 mb-1">Enforce No Adjacent
                        Same Batch</label>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="enforceAdj" class="h-5 w-5">
                        <label for="enforceAdj" class="text-sm text-gray-600">Optional</label>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <label for="batch_student_counts" class="block text-sm font-medium text-gray-700 mb-1">Batch Student
                        Counts (optional)</label>
                    <input type="text" id="batch_student_counts" placeholder="e.g. 1:35,2:30,3:25"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <p class="text-xs text-gray-500 mt-1">Format: batchIndex:count, separated by commas. Shows
                        unallocated if total < available seats</p>
                </div>
            </div>

            <div class="text-center mt-6 flex gap-3 justify-center flex-wrap">
                <button id="generateBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-0.5">Generate
                    Chart</button>
                <button id="downloadPdfBtn"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-0.5"
                    disabled>
                    Download PDF</button>
                <button id="constraintsBtn"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                    View Constraints</button>
            </div>
        </div>

        <!-- Seating Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Seating Chart</h2>
            <div id="validation-result" class="mb-4"></div>
            <div id="seating-chart" class="grid gap-3 overflow-auto"
                style="grid-template-columns: repeat(var(--cols, 10), 96px);">
                <!-- seats generated here -->
            </div>
            <div id="summary" class="mt-4"></div>
        </div>
    </div>

    <script>
        // Store seating data for PDF generation
        let currentSeatingData = null;

        const rowsInput = document.getElementById('rows');
        const colsInput = document.getElementById('cols');
        const numBatchesInput = document.getElementById('num-batches');
        const brokenSeatsInput = document.getElementById('broken-seats');
        const generateBtn = document.getElementById('generateBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const chart = document.getElementById('seating-chart');
        const blockWidthInput = document.getElementById('block-width');
        const fillByColumn = document.getElementById('fillByColumn');

        // Function to regenerate batch start roll inputs
        function updateBatchInputs() {
            const numBatches = parseInt(numBatchesInput.value) || 3;
            const container = document.getElementById('batch-rolls-inputs');
            container.innerHTML = '';

            const colors = ['blue', 'green', 'indigo', 'purple', 'pink', 'red', 'yellow', 'cyan', 'amber', 'rose'];

            for (let i = 1; i <= numBatches; i++) {
                const colorClass = colors[(i - 1) % colors.length];
                const defaultRoll = i === 1 ? 1 : i === 2 ? 101 : i === 3 ? 201 : (i * 100 + 1);

                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="startRoll${i}" class="block text-sm font-medium text-gray-700 mb-1">
                        Batch ${i} Start Roll
                    </label>
                    <input type="number" id="startRoll${i}" name="startRoll${i}" min="1" value="${defaultRoll}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-${colorClass}-500 focus:border-${colorClass}-500 transition">
                `;
                container.appendChild(div);
            }
        }

        // Listen for changes to number of batches
        numBatchesInput.addEventListener('change', updateBatchInputs);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateBatchInputs();
        });

        function generateSeatingChart() {
            const rows = parseInt(rowsInput.value) || 0;
            const cols = parseInt(colsInput.value) || 0;
            const numBatches = parseInt(numBatchesInput.value) || 3;
            const blockWidth = parseInt(blockWidthInput.value) || 3;

            // Collect start rolls from dynamic inputs
            let startRollsStr = '';
            for (let i = 1; i <= numBatches; i++) {
                const rollInput = document.getElementById(`startRoll${i}`);
                if (rollInput) {
                    const roll = rollInput.value;
                    if (startRollsStr) startRollsStr += ',';
                    startRollsStr += `${i}:${roll}`;
                }
            }

            const payload = {
                rows: rows,
                cols: cols,
                num_batches: numBatches,
                block_width: blockWidth,
                batch_by_column: fillByColumn.checked,
                enforce_no_adjacent_batches: document.getElementById('enforceAdj').checked,
                broken_seats: document.getElementById('broken-seats') ? document.getElementById('broken-seats').value : '',
                batch_student_counts: document.getElementById('batch_student_counts') ? document.getElementById('batch_student_counts').value : '',
                // pass per-batch start rolls if provided
                start_rolls: document.getElementById('start_rolls') ? document.getElementById('start_rolls').value : '',
                start_serials: startRollsStr
            };

            chart.innerHTML = '';
            chart.style.setProperty('--cols', cols);

            if (rows === 0 || cols === 0) {
                chart.innerHTML = '<p class="text-center text-gray-500 col-span-full">Please enter valid rows and columns.</p>';
                return;
            }

            // call backend
            fetch('/api/generate-seating', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if (data.error) {
                    document.getElementById('validation-result').innerHTML = `<div class="text-red-600">${data.error}</div>`;
                    downloadPdfBtn.disabled = true;
                    return;
                }

                // Store complete data for PDF generation via API
                currentSeatingData = data;

                // render seating using server-provided roll_number and metadata
                const meta = data.metadata || { rows: rows, cols: cols, block_width: blockWidth };
                const seating = data.seating || [];
                chart.style.setProperty('--cols', meta.cols || cols);
                // build grid
                seating.forEach((row, rIdx) => {
                    row.forEach((seat, cIdx) => {
                        const seatDiv = document.createElement('div');

                        // Handle broken seats
                        if (seat.is_broken) {
                            seatDiv.className = 'rounded-lg p-3 text-center shadow-md border-2 transition-all duration-200 min-h-[96px] w-[88px] flex flex-col justify-center items-center overflow-hidden';
                            seatDiv.style.backgroundColor = '#FF0000';
                            seatDiv.style.borderColor = '#CC0000';
                            seatDiv.innerHTML = `<div class="font-bold text-white text-sm">BROKEN</div><div class="text-xs text-gray-100">${seat.position}</div>`;
                        } else if (seat.is_unallocated) {
                            // Unallocated seats - light gray
                            seatDiv.className = 'rounded-lg p-3 text-center shadow-md border border-gray-300 transition-all duration-200 min-h-[96px] w-[88px] flex flex-col justify-center items-center overflow-hidden';
                            seatDiv.style.backgroundColor = '#F3F4F6';
                            seatDiv.innerHTML = `
                        <div class="font-semibold text-sm text-gray-600">Batch ${seat.batch}</div>
                        <div class="font-bold text-sm text-gray-500">UNALLOCATED</div>
                        <div class="text-xs text-gray-500">${seat.position}</div>
                    `;
                        } else {
                            // Normal allocated seat with batch color
                            const rn = seat.roll_number || '';
                            const set = seat.paper_set || '';
                            seatDiv.className = 'rounded-lg p-3 text-center shadow-md border border-gray-300 transition-all duration-200 min-h-[96px] w-[88px] flex flex-col justify-center items-center overflow-hidden';
                            // Apply color from backend
                            seatDiv.style.backgroundColor = seat.color || '#FFFFFF';
                            seatDiv.innerHTML = `
                        <div class="font-semibold text-sm">Batch ${seat.batch}</div>
                        <div class="font-bold text-sm break-words max-w-full text-center">${rn}</div>
                        <div class="font-medium text-xs">Set: ${set}</div>
                        <div class="text-xs opacity-70 mt-1">${seat.position}</div>
                    `;
                        }

                        // visual block separation using metadata block_width
                        const bw = meta.block_width || blockWidth;
                        if ((cIdx) % bw === 0 && cIdx !== 0) {
                            seatDiv.style.borderLeft = '8px solid rgba(0,0,0,0.06)';
                            seatDiv.style.marginLeft = '12px';
                            seatDiv.style.paddingLeft = '8px';
                        }

                        chart.appendChild(seatDiv);
                    });
                });

                // Enable download button now that we have a chart
                downloadPdfBtn.disabled = false;

                // show validation
                const v = data.validation || { is_valid: true, errors: [] };
                if (v.is_valid) {
                    document.getElementById('validation-result').innerHTML = '<div class="text-green-600">All constraints satisfied</div>';
                } else {
                    document.getElementById('validation-result').innerHTML = `<div class="text-red-600">Violations:<ul>${v.errors.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
                }

                // summary
                const summaryEl = document.getElementById('summary');
                const summary = data.summary || {};

                // Build unallocated students display
                let unallocatedHtml = '';
                if (summary.unallocated_per_batch) {
                    unallocatedHtml = '<div class="p-3 bg-orange-50 rounded border border-orange-200">';
                    unallocatedHtml += '<strong class="text-orange-700">Unallocated Students per Batch:</strong><br/>';
                    const numBatches = parseInt(numBatchesInput.value) || 3;
                    for (let b = 1; b <= numBatches; b++) {
                        const unalloc = summary.unallocated_per_batch[b] || 0;
                        unallocatedHtml += `<div class="text-sm text-orange-600">Batch ${b}: ${unalloc} students</div>`;
                    }
                    unallocatedHtml += '</div>';
                }

                let brokenSeatsDisplay = '';
                if (summary.broken_seats_count && summary.broken_seats_count > 0) {
                    brokenSeatsDisplay = `<div class="p-3 bg-red-50 rounded border border-red-200"><strong class="text-red-700">Broken Seats:</strong> ${summary.broken_seats_count}</div>`;
                }

                summaryEl.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="p-3 bg-gray-50 rounded">
                    <strong>Total Available Seats:</strong> ${summary.total_available_seats || 0}
                </div>
                <div class="p-3 bg-gray-50 rounded">
                    <strong>Allocated Students:</strong> ${summary.total_allocated_students || 0}
                </div>
            </div>
            <div class="mt-3">
                ${brokenSeatsDisplay}
            </div>
            <div class="mt-3">
                ${unallocatedHtml}
            </div>
            <div class="mt-3 grid grid-cols-2 gap-3">
                <div class="p-3 bg-blue-50 rounded">
                    <strong>Batch Distribution:</strong>
                    <pre class="text-sm mt-1">${JSON.stringify(summary.batch_distribution || {})}</pre>
                </div>
                <div class="p-3 bg-blue-50 rounded">
                    <strong>Paper Set Distribution:</strong>
                    <pre class="text-sm mt-1">${JSON.stringify(summary.paper_set_distribution || {})}</pre>
                </div>
            </div>
        `;

            }).catch(err => {
                document.getElementById('validation-result').innerHTML = `<div class="text-red-600">${err.message}</div>`;
                downloadPdfBtn.disabled = true;
            });
        }

        generateBtn.addEventListener('click', generateSeatingChart);
        // initial render
        generateSeatingChart();

        // PDF download functionality - PROFESSIONAL STANDARDIZED FORMAT
        downloadPdfBtn.addEventListener('click', async function () {
            if (!currentSeatingData) {
                alert('Please generate seating first');
                return;
            }

            try {
                downloadPdfBtn.disabled = true;
                downloadPdfBtn.textContent = 'Generating PDF...';

                // Call backend API to generate PDF
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSeatingData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'PDF generation failed');
                }

                // Download PDF file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `seating_${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.textContent = 'Download PDF';
            }
        });

        // Constraints checker button
        document.getElementById('constraintsBtn').addEventListener('click', function () {
            const rows = parseInt(rowsInput.value) || 0;
            const cols = parseInt(colsInput.value) || 0;
            const numBatches = parseInt(numBatchesInput.value) || 3;
            const blockWidth = parseInt(blockWidthInput.value) || 3;

            const payload = {
                rows: rows,
                cols: cols,
                num_batches: numBatches,
                block_width: blockWidth,
                batch_by_column: fillByColumn.checked,
                enforce_no_adjacent_batches: document.getElementById('enforceAdj').checked,
                broken_seats: brokenSeatsInput.value,
                batch_student_counts: document.getElementById('batch_student_counts').value
            };

            fetch('/api/constraints-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Build HTML for constraints modal
                const constraints = data.constraints || [];
                let html = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Applied Constraints Status</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-2xl text-gray-600 hover:text-gray-800">×</button>
                            </div>
                            <div class="space-y-3">
                `;

                constraints.forEach(c => {
                    const statusIcon = c.satisfied ? '✓' : '✗';
                    const statusColor = c.satisfied ? 'text-green-600' : 'text-red-600';
                    const appliedTag = c.applied ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Applied</span>' : '<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">Not Applied</span>';

                    html += `
                        <div class="border rounded-lg p-3 ${c.satisfied ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl font-bold ${statusColor}">${statusIcon}</span>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${c.name}</h3>
                                        <p class="text-sm text-gray-600">${c.description}</p>
                                    </div>
                                </div>
                                <div>${appliedTag}</div>
                            </div>
                            <div class="text-xs font-medium">
                                <span class="${c.satisfied ? 'text-green-700' : 'text-red-700'}">
                                    ${c.satisfied ? 'SATISFIED' : 'NOT SATISFIED'}
                                </span>
                            </div>
                        </div>
                    `;
                });

                html += `
                            </div>
                            <div class="mt-4 pt-4 border-t text-right">
                                <div class="text-sm text-gray-600 mb-3">
                                    <strong>${data.total_satisfied}/${data.total_applied}</strong> constraints satisfied
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                // Insert modal into page
                const modal = document.createElement('div');
                modal.innerHTML = html;
                document.body.appendChild(modal.firstElementChild);
            }).catch(err => {
                alert('Error fetching constraints: ' + err.message);
            });
        });
    </script>
</body>

</html>